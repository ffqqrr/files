<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>å°è½¦é¥æ§</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<link rel="icon" href="https://f.fqr-qwq.cn/project/saoraoqi/icon.png" type="image/png">
</head>
<body style="background-color: rgb(248,248,248)">
    <script src="https://f.fqr-qwq.cn/project/mqtt.min.js"></script>
    <style>
        input[type=range] 
        {     
            outline: none;     
            border-radius: 5px; 
        }
    </style>
    
    <div>
        <div style="width: 360px; height: 80px; background-color: rgb(255, 255, 255); border-radius: 10px; border:1px solid rgb(200,200,200); position: absolute; left: 10px; top: 10px;">
            <center><p style="margin-top: 10px;">é€Ÿåº¦</p></center>
            <center><input type="range" name="points" min="0" max="255" id="speed" style="width: 300px;"/> </center>
        </div>

        <div style="width: 100px; height: 100px; border-radius: 50px; background-color: rgb(255,255,255); border:5px solid rgb(204,204,204); cursor: pointer;  user-select: none; position: absolute; left: 10px; top: 100px; font-size: 75px;" id="up" onmousedown="open_k('up')" onmouseup="close_k('up')" onmouseout="close_k('up')">
            <center>â†‘</center>
        </div>

        <div style="width: 100px; height: 100px; border-radius: 50px; background-color: rgb(255,255,255); border:5px solid rgb(204,204,204); cursor: pointer;  user-select: none; position: absolute; left: 10px; top: 220px; font-size: 75px;" id="down" onmousedown="open_k('down')" onmouseup="close_k('down')" onmouseout="close_k('down')">
            <center>â†“</center>
        </div>

        <div style="width: 100px; height: 100px; border-radius: 50px; background-color: rgb(255,255,255); border:5px solid rgb(204,204,204); cursor: pointer;  user-select: none; position: absolute; left: 130px; top: 150px; font-size: 75px;" id="left" onmousedown="open_k('left')" onmouseup="close_k('left')" onmouseout="close_k('left')">
            <center>â†</center>
        </div>

        <div style="width: 100px; height: 100px; border-radius: 50px; background-color: rgb(255,255,255); border:5px solid rgb(204,204,204); cursor: pointer;  user-select: none; position: absolute; left: 250px; top: 150px; font-size: 75px;" id="right" onmousedown="open_k('right')" onmouseup="close_k('right')" onmouseout="close_k('right')">
            <center>â†’</center>
        </div>

        <div style="width: 100px; height: 100px; border-radius: 50px; background-color: rgb(255,255,255); border:5px solid rgb(204,204,204); cursor: pointer;  user-select: none; position: absolute; left: 130px; top: 350px; font-size: 75px;" id="fmq" onmousedown="open_k('fmq')" onmouseup="close_k('fmq')" onmouseout="close_k('fmq')">
            <center>ğŸ”ˆ</center>
        </div>

    </div>

    <script>
        document.onselectstart=function(){return false}
        document.ondragstart=function(){return false}

        function getRandomString(length) {
            var result = '';
            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            var charactersLength = characters.length;
            for (var i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }
        // è¿æ¥é€‰é¡¹
        const options = {
            clean: true, // true: æ¸…é™¤ä¼šè¯, false: ä¿ç•™ä¼šè¯
            connectTimeout: 4000, // è¶…æ—¶æ—¶é—´
            // è®¤è¯ä¿¡æ¯
            clientId: 'car-yaokong-'+getRandomString(16),	//å®¢æˆ·ç«¯ID
            username: 'FQR', //è¿æ¥ç”¨æˆ·å
            password: 'fqrzn081230',//è¿æ¥å¯†ç ï¼Œé»˜è®¤ä¸ºpublic,æ–°ç‰ˆæœ¬ç™»å½•åå°ç•Œé¢ä¼šè®©ä½ ä¿®æ”¹å¯†ç 
            // å¿ƒè·³æ—¶é—´
            keepalive: 60,
        }

        // è¿æ¥å­—ç¬¦ä¸², é€šè¿‡åè®®æŒ‡å®šä½¿ç”¨çš„è¿æ¥æ–¹å¼
        const connectUrl = 'ws://39.107.120.123:8083/mqtt' //è¿æ¥æœåŠ¡ç«¯åœ°å€ï¼Œæ³¨æ„æŸ¥çœ‹wsåè®®å¯¹åº”çš„ç«¯å£å·
        var client;
        try {
            client = mqtt.connect(connectUrl, options)
        } catch (e) {
            window.location="http://39.107.120.123/car";
        }

        client.on('connect', () => {
            console.log('è¿æ¥æˆåŠŸ')
            // è®¢é˜…å¤šä¸ªä¸»é¢˜
            client.subscribe(
                ['fqr/saoraoqi-o/#'], //ä¸»é¢˜
                { qos: 1 },  
                (err) => {
                    console.log(err || 'è®¢é˜…æˆåŠŸ')
                },
            );
            // å‘å¸ƒæ¶ˆæ¯
        })
        //å¤±è´¥é‡è¿
        client.on('reconnect', (error) => {
            console.log('æ­£åœ¨é‡è¿:', error)
        })
        //è¿æ¥å¤±è´¥
        client.on('error', (error) => {
            console.log('è¿æ¥å¤±è´¥:', error)
        })
        //æ¥æ”¶æ¶ˆæ¯
        client.on('message', (topic, message) => {
            /*console.log('æ”¶åˆ°æ¶ˆæ¯ï¼š', topic, message.toString())*/
        })
        
        function send(topic,value)
        {
            client.publish(topic, value, (err) => {/*console.log(err || ("å‘â€œ"+topic+"â€å‘é€â€œ"+value+'â€ï¼Œå‘å¸ƒæˆåŠŸ'))*/});
        }

        send("fqr/car/speed","125");

        /*
        è®¢é˜…æ¶ˆæ¯ï¼š
        client.subscribe(
            ['tourist_enter', 'message_arrived'], //ä¸»é¢˜
            { qos: 1 },  
            (err) => {
                console.log(err || 'è®¢é˜…æˆåŠŸ')
            },
        );
        å‘å¸ƒæ¶ˆæ¯ï¼š
        client.publish('tourist_enter', 'Hello EMQ X', (err) => {console.log(err || 'å‘å¸ƒæˆåŠŸ')});
        æ¥æ”¶æ¶ˆæ¯ï¼š
        client.on('message', (topic, message) => {
            console.log('æ”¶åˆ°æ¶ˆæ¯ï¼š', topic, message.toString())
        })    
        */

        var u,d,l,r;


        
        function open_k(s)
        {
            send('fqr/car/'+s,'1');
            document.getElementById(s).style.backgroundColor='rgb(0, 187, 16)';
            if(s=="up") u=1;
            else if(s=="down") d=1;
            else if(s=="left") l=1;
            else r=1;
        }

        function close_k(s)
        {
            if(s=="up"&&!u) return;
            else if(s=="down"&&!d) return;
            else if(s=="left"&&!l) return;
            else if(s=="right"&&!r) return;

            send('fqr/car/'+s,'0');
            document.getElementById(s).style.backgroundColor='rgb(255, 255, 255)';

            if(s=="up") u=0;
            else if(s=="down") d=0;
            else if(s=="left") l=0;
            else r=0;
        }
        document.getElementById("up").addEventListener("touchstart",function(){open_k("up");});
        document.getElementById("up").addEventListener("touchend",function(){close_k("up");});
        document.getElementById("up").addEventListener("mouseout",function(){close_k("up");});

        document.getElementById("down").addEventListener("touchstart",function(){open_k("down");});
        document.getElementById("down").addEventListener("touchend",function(){close_k("down");});
        document.getElementById("down").addEventListener("mouseout",function(){close_k("down");});

        document.getElementById("left").addEventListener("touchstart",function(){open_k("left");});
        document.getElementById("left").addEventListener("touchend",function(){close_k("left");});
        document.getElementById("left").addEventListener("mouseout",function(){close_k("left");});

        document.getElementById("right").addEventListener("touchstart",function(){open_k("right");});
        document.getElementById("right").addEventListener("touchend",function(){close_k("right");});
        document.getElementById("right").addEventListener("mouseout",function(){close_k("right");});

        document.getElementById("fmq").addEventListener("touchstart",function(){open_k("fmq");});
        document.getElementById("fmq").addEventListener("touchend",function(){close_k("fmq");});
        document.getElementById("fmq").addEventListener("mouseout",function(){close_k("fmq");});

        var speed_lst=0;

        setInterval(function() {
            var speed=document.getElementById("speed").value;
            if(Math.abs(speed_lst-speed)>=10)
            {
                send("fqr/car/speed",String(speed));
                speed_lst=speed;
            }
        }, 0);


    
    </script>
</body>
</html>

