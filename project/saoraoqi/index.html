<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>小猪骚扰器</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
</head>
<body style="background-color: rgb(248,248,248)">
    <style>
        @keyframes open-kuang {
            0% { background-color: rgb(204,204,204); }
            100% { background-color: rgb(0, 187, 16); }
        }
        .open-kg-kuang
        {
            animation: open-kuang 200ms infinite linear;
            animation-iteration-count: 1;
        }


        @keyframes close-kuang {
            0% { background-color: rgb(0, 187, 16); }
            100% { background-color: rgb(204,204,204); }
        }
        .close-kg-kuang
        {
            animation: close-kuang 200ms infinite linear;
            animation-iteration-count: 1;
        }

        @keyframes open-ball {
            0% { margin-left: 3px; }
            100% { margin-left: 31px; }
        }
        .open-kg-ball
        {
            animation: open-ball 200ms infinite linear;
            animation-iteration-count: 1;
        }

        @keyframes close-ball {
            0% { margin-left: 31px; }
            100% { margin-left: 3px; }
        }
        .close-kg-ball
        {
            animation: close-ball 200ms infinite linear;
            animation-iteration-count: 1;
        }
    </style>
    <script src="https://f.fqr-qwq.cn/project/mqtt.min.js"></script>
    <script>
        document.onselectstart=function(){return false}
        document.ondragstart=function(){return false}
        
        var cnt_msg=0;
        var timer1 = setInterval(function() {
            if(cnt_msg) setbulb(1);
            else setbulb(0);
            cnt_msg=0;
        }, 2000);

        function getRandomString(length) {
            var result = '';
            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            var charactersLength = characters.length;
            for (var i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }
        // 连接选项
        const options = {
            clean: true, // true: 清除会话, false: 保留会话
            connectTimeout: 4000, // 超时时间
            // 认证信息
            clientId: 'saoraoqi-'+getRandomString(16),	//客户端ID
            username: 'emqx', //连接用户名
            password: 'public',//连接密码，默认为public,新版本登录后台界面会让你修改密码
            // 心跳时间
            keepalive: 60,
        }

        // 连接字符串, 通过协议指定使用的连接方式
        const connectUrl = 'wss://broker.emqx.io:8084/mqtt' //连接服务端地址，注意查看ws协议对应的端口号
        const client = mqtt.connect(connectUrl, options)

        client.on('connect', () => {
            console.log('连接成功')
            // 订阅多个主题
            client.subscribe(
                ['fqr/saoraoqi-o/#'], //主题
                { qos: 1 },  
                (err) => {
                    console.log(err || '订阅成功')
                },
            );
            // 发布消息
        })
        //失败重连
        client.on('reconnect', (error) => {
            console.log('正在重连:', error)
        })
        //连接失败
        client.on('error', (error) => {
            console.log('连接失败:', error)
        })
        //接收消息
        client.on('message', (topic, message) => {
            console.log('收到消息：', topic, message.toString())
            cnt_msg++;

            if(topic=="fqr/saoraoqi-o/dht1")
            {
                document.getElementById("dht1").innerText=message;
            }

            if(topic=="fqr/saoraoqi-o/dht2")
            {
                document.getElementById("dht2").innerText=message;
            }
        })
        
        function send(topic,value)
        {
            client.publish(topic, value, (err) => {console.log(err || ("向“"+topic+"”发送“"+value+'”，发布成功'))});
        }

        /*
        订阅消息：
        client.subscribe(
            ['tourist_enter', 'message_arrived'], //主题
            { qos: 1 },  
            (err) => {
                console.log(err || '订阅成功')
            },
        );
        发布消息：
        client.publish('tourist_enter', 'Hello EMQ X', (err) => {console.log(err || '发布成功')});
        接收消息：
        client.on('message', (topic, message) => {
            console.log('收到消息：', topic, message.toString())
        })    
        */

        var light_mode=0,fmq_mode=0;
        function light()
        {
            if(light_mode==0)
            {
                send('fqr/saoraoqi/light','1');
                document.getElementById("light_kuang").style.backgroundColor='rgb(0, 187, 16)';
                document.getElementById("light_ball").style.marginLeft='31px';
                document.getElementById("light_ball").className='open-kg-ball';
                document.getElementById("light_kuang").className="open-kg-kuang";
            }
            else
            {
                send('fqr/saoraoqi/light','0');
                document.getElementById("light_kuang").style.backgroundColor='rgb(204,204,204)';
                document.getElementById("light_ball").style.marginLeft='3px';
                document.getElementById("light_ball").className='close-kg-ball';
                document.getElementById("light_kuang").className="close-kg-kuang";
            }
            light_mode=!light_mode;
        }


        
        function fmq_open()
        {
            send('fqr/saoraoqi/fmq','1');
            document.getElementById("fmq_ball").style.backgroundColor='rgb(0, 187, 16)';
            fmq_mode=1;
        }

        function fmq_close()
        {
            if(!fmq_mode) return;
            send('fqr/saoraoqi/fmq','0');
            document.getElementById("fmq_ball").style.backgroundColor='rgb(255, 255, 255)';
            fmq_mode=0;
        }
        window.onload = function() {
            document.getElementById("fmq_ball").addEventListener("touchstart",fmq_open);
            document.getElementById("fmq_ball").addEventListener("touchend",fmq_close);
        };

        function setbulb(x)
        {
            if(x==1) document.getElementById("bulb").style.backgroundColor='rgb(28,200,138)',document.getElementById("bulb").style.boxShadow="rgb(28,200,138) 1px 1px 8px";
            else document.getElementById("bulb").style.backgroundColor='rgb(231,74,59)',document.getElementById("bulb").style.boxShadow="rgb(231,74,59) 1px 1px 8px";
        }

    </script>
    <div>
        <div style="width: 100px; height: 100px; background-color: rgb(255, 255, 255); border-radius: 10px; border:1px solid rgb(200,200,200); position: absolute; left: 10px; top: 10px;">
            <center><div style="width: 50px; height: 50px; border-radius: 30px; background-color: rgb(204,204,204); margin-top: 25px; box-shadow: rgb(204,204,204) 1px 1px 8px;" id="bulb"></div></center>
        </div>

        <div style="width: 100px; height: 100px; background-color: rgb(255, 255, 255); border-radius: 10px; border:1px solid rgb(200,200,200); position: absolute; left: 120px; top: 10px;">
            <center><p style="padding-top: 0px; font-size: 16px; user-select: none;">灯光</p></center>
            <center>
                <div style="background-color: rgb(204,204,204); width: 60px;height: 30px; border-radius: 15px; cursor: pointer;" id="light_kuang" onmouseup="light()">
                    <div style="background-color: white; width: 24px; height: 24px; border-radius: 15px; margin-left: 3px; margin-top:3px; position: absolute" id="light_ball"></div>
                </div>
            </center>
        </div>

        <div style="width: 100px; height: 100px; background-color: rgb(255, 255, 255); border-radius: 10px; border:1px solid rgb(200,200,200); position: absolute; left: 230px; top: 10px;">
            <center><p style="padding-top: 0px; font-size: 16px; user-select: none;">蜂鸣器</p></center>
            <center>
                <div style="width: 28px; height: 28px; border-radius: 20px; background-color: rgb(255,255,255); border:5px solid rgb(204,204,204); cursor: pointer;" id="fmq_ball" onmousedown="fmq_open()" onmouseup="fmq_close()" onmouseout="fmq_close()"></div>
            </center>
        </div>
        
        <div style="width: 155px; height: 100px; background-color: rgb(255, 255, 255); border-radius: 10px; border:1px solid rgb(200,200,200); position: absolute; left: 10px; top: 120px;">
            <center><p style="padding-top: 0px; font-size: 16px; user-select: none;">温度</p></center>
            <center>
                <div style="width: 120px; height: 30px; border-radius: 10px; background-color: rgb(255,255,255); border:1px solid rgb(204,204,204); margin-top: -5px; padding-top: 5px;" id="dht1"> </div>
            </center>
        </div>

        <div style="width: 155px; height: 100px; background-color: rgb(255, 255, 255); border-radius: 10px; border:1px solid rgb(200,200,200); position: absolute; left: 175px; top: 120px;">
            <center><p style="padding-top: 0px; font-size: 16px; user-select: none;">湿度</p></center>
            <center>
                <div style="width: 120px; height: 30px; border-radius: 10px; background-color: rgb(255,255,255); border:1px solid rgb(204,204,204); margin-top: -5px; padding-top: 5px;" id="dht2"> </div>
            </center>
        </div>

    </div>

</body>
</html>

